# --- Build RedisJSON v1 for the same libc/arch as runtime ---
FROM debian:bookworm-slim as rjson-builder
ARG REDISJSON_VERSION=v1.0.4
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git ca-certificates make && \
    rm -rf /var/lib/apt/lists/*
WORKDIR /src

# Grab the exact tag + submodules
RUN git clone https://github.com/RedisJSON/RedisJSON.git . && \
    git checkout ${REDISJSON_VERSION} && \
    git submodule update --init --recursive

# Build: point rmutil at the header location and relax GCC 10+ changes
# -I/src/src  -> where redismodule.h is
# RM_INCLUDE_DIR / REDISMODULE_INCLUDE_DIR -> rmutil makefile variables
RUN make -C src \
      CC="gcc" \
      CFLAGS="-O2 -fPIC -fcommon -I/src/src" \
      RM_INCLUDE_DIR="/src/src" \
      REDISMODULE_INCLUDE_DIR="/src/src" \
      LDFLAGS="-Wl,--allow-multiple-definition"

RUN mkdir -p /out && cp src/rejson.so /out/


FROM eqalpha/keydb:latest
ENV LIBDIR=/usr/lib/redis/modules
RUN mkdir -p ${LIBDIR}
COPY --from=rjson-builder /out/rejson.so ${LIBDIR}/
# optional sanity checks during build
RUN test -f ${LIBDIR}/rejson.so && file ${LIBDIR}/rejson.so || true
CMD ["keydb-server", "--loadmodule", "/usr/lib/redis/modules/rejson.so"]
